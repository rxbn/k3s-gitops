---
apiVersion: v1
kind: ConfigMap
metadata:
  name: merge-subtitles
  namespace: usenet
data:
  merge_subtitles.sh: |
    #!/usr/bin/env bash

    set -o errexit
    set -o pipefail

    cd "${SAB_COMPLETE_DIR}"

    FILENAME=$(find -type f -name "*.mkv" -and -not -iname "*sample*" | head -n 1)

    if [[ -z ${FILENAME} ]]; then
        echo "no mkv file found - skipping"
        exit 0
    fi

    SUBS=$(find -type f -name "*.idx" -or -name "*.srt")

    if [[ -z ${SUBS} ]]; then
        echo "no subtitles found - skipping"
        exit 0
    fi

    while IFS= read -r SUB; do
        mkvmerge -o ${FILENAME}.merged ${FILENAME} ${SUB}
        rm -f ${FILENAME}
        mv ${FILENAME}.merged ${FILENAME}
    done <<< "${SUBS}"
    echo "finished merging subtitles"

    exit 0
